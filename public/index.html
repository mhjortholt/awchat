<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title></title>
  </head>
  <body>

    <label>Your ID:</label><br/>
    <textarea id="yourId"></textarea><br/>
    <label>Other ID:</label><br/>
    <textarea id="otherId"></textarea>
    <button id="connect">connect</button><br/>

    <label>Enter Message:</label><br/>
    <textarea id="yourMessage"></textarea>
    <button id="send">send</button>
    <pre id="messages"></pre><br />
    <button id="play">PLAY</button><br/>

    <script src="js/jquery.js" charset="utf-8"></script>
    <script src="js/simple-peer.min.js" charset="utf-8"></script>
    <script>

    function uuidv4() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }
    var id = uuidv4();

    var video = document.createElement('video')
    document.body.appendChild(video);

    navigator.mediaDevices.getUserMedia({video: { facingMode: "user" }, audio: true})
    .then(function(stream) {

        var peer = new SimplePeer({
          initiator: location.hash === '#init',
          trickle: false,
          stream: stream
        })

        peer.on('signal', function (data) {
          document.getElementById('yourId').value = JSON.stringify(data)

          var p = {
            id: id,
            data: data,
            user: location.hash === '#init' ? 0 : 1
          };

          $.ajax({
            url: '/api/addme',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(p),
            success: function(response){
              console.log(response);
            }
          })
        })

        document.getElementById('connect').addEventListener('click', function () {
          
          $.ajax({
            url: '/api/get',
            type: 'GET',
            contentType: 'application/json',
            success: function(response){
              console.log(response)
              var data = response[location.hash === '#init' ? 1 : 0].data;
              document.getElementById('otherId').value = JSON.stringify(data);

              var otherId = data
              peer.signal(otherId)

            }
          })

        })

        document.getElementById('send').addEventListener('click', function () {
          var yourMessage = document.getElementById('yourMessage').value
          peer.send(yourMessage)
        })

        peer.on('data', function (data) {
          document.getElementById('messages').textContent += data + '\n'
        })

        peer.on('stream', function (stream) {

          if ('srcObject' in video) {
            video.srcObject = stream
          } else {
            video.src = window.URL.createObjectURL(stream) // for older browsers
          }

          video.play()
        })

        document.getElementById('play').addEventListener('click', function () {
          video.play()
        })

    })
    .catch(function(err) {
      /* handle the error */
      console.error(err)
    });




    </script>
  </body>
</html>